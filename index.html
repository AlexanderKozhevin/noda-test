<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Noda VR Smoke Test</title>

  <!-- Официальный include -->
  <script src="https://noda.io/api/includes/noda.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; }
    .box { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .ok { background:#e9fbe9; }
    .bad { background:#ffe9e9; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #999; background:#f7f7f7; cursor:pointer; margin-right: 8px; }
    textarea { width: 100%; min-height: 180px; font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; font-size: 12px; }
    .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; }
  </style>

  <script>
    let statusEl, logEl;
    let ready = false;

    function setStatus(ok, msg) {
      statusEl.className = "box " + (ok ? "ok" : "bad");
      statusEl.innerHTML = msg;
    }

    function addLog(msg) {
      logEl.value = (msg + "\n" + logEl.value).slice(0, 20000);
    }

    function mustReady() {
      if (!ready) throw new Error("Not ready: Noda WebAPI not initialized yet.");
      if (!window.noda) throw new Error("window.noda is missing.");
      if (!window.noda.isInstalled()) throw new Error("Noda VR context not found (not opened inside Noda Browser).");
    }

    document.addEventListener("DOMContentLoaded", () => {
      statusEl = document.getElementById("status");
      logEl = document.getElementById("log");

      // События — чтобы видеть, что хоть что-то приходит
      window.noda.onNodeCreated = (n) => addLog("onNodeCreated uuid=" + n.uuid);
      window.noda.onLinkCreated = (l) => addLog("onLinkCreated uuid=" + l.uuid);

      window.noda.onInitialized = async () => {
        try {
          const installed = window.noda.isInstalled();
          addLog("onInitialized. isInstalled=" + installed);

          if (!installed) {
            setStatus(false, "❌ Не вижу VR-контекст. Открой эту страницу через <b>Noda → Application Menu → Browser</b> (не через обычный Quest Browser).");
            return;
          }

          const user = await window.noda.getUser();
          ready = true;
          setStatus(true, "✅ WebAPI готов. userId: <span class='mono'>" + user.userId + "</span><br/>Теперь жми кнопки ниже — ноды должны появляться ПРЯМО ПЕРЕД ОКНОМ (relativeTo=Window).");
        } catch (e) {
          setStatus(false, "❌ Ошибка инициализации: <span class='mono'>" + String(e) + "</span>");
          addLog("init error: " + String(e));
        }
      };
    });

    async function clearMap() {
      try {
        mustReady();
        addLog("clearMap()");
        await window.noda.clearMap();
        addLog("clearMap OK");
      } catch (e) {
        addLog("clearMap ERROR: " + String(e));
        setStatus(false, "❌ clearMap: <span class='mono'>" + String(e) + "</span>");
      }
    }

    async function createOneHugeNode() {
      try {
        mustReady();
        addLog("createOneHugeNode()");

        const node = await window.noda.createNode({
          uuid: "smoke:one",
          title: "SMOKE TEST: Я ДОЛЖЕН БЫТЬ ВИДЕН",
          color: "F44336",
          opacity: 1,
          shape: "Box",
          size: 20,
          notes: "Если ты видишь эту ноду в VR — API работает.",
          location: {
            x: 0, y: 0.0, z: -0.8,
            relativeTo: "Window"   // ключевая вещь: прямо перед браузерным окном
          }
        });

        addLog("created node uuid=" + node.uuid);
        setStatus(true, "✅ Создал ноду <span class='mono'>" + node.uuid + "</span>. Она должна быть прямо перед окном браузера.");
      } catch (e) {
        addLog("createOneHugeNode ERROR: " + String(e));
        setStatus(false, "❌ createNode: <span class='mono'>" + String(e) + "</span>");
      }
    }

    async function createManyNodes() {
      try {
        mustReady();
        addLog("createManyNodes()");

        // создадим 120 нод “облаком” перед окном
        const N = 120;
        for (let i = 0; i < N; i++) {
          const row = i % 12;
          const col = Math.floor(i / 12);

          const x = (row - 5.5) * 0.12;     // ширина
          const y = (col * 0.10);           // высота
          const z = -1.2 - (i % 6) * 0.06;  // глубина

          const nodeProps = {
            uuid: "smoke:n" + i,
            title: "log #" + i,
            color: (i % 2 === 0) ? "2196F3" : "4CAF50",
            opacity: 1,
            shape: (i % 4 === 0) ? "Star" : (i % 4 === 1) ? "Diamond" : (i % 4 === 2) ? "Hourglass" : "Box",
            size: 6,
            notes: "bulk node " + i,
            location: { x, y, z, relativeTo: "Window" }
          };

          await window.noda.createNode(nodeProps);
        }

        // линк между первой и последней — просто чтобы проверить link
        await window.noda.createLink({
          uuid: "smoke:link",
          fromUuid: "smoke:n0",
          toUuid: "smoke:n119",
          title: "range",
          color: "171717",
          shape: "Dash",
          size: 2,
          curve: "None",
          trail: "Ring",
          selected: false
        });

        setStatus(true, "✅ Создал " + N + " нод + 1 линк. Ты должен увидеть “стенку” из элементов перед окном.");
        addLog("createManyNodes OK");
      } catch (e) {
        addLog("createManyNodes ERROR: " + String(e));
        setStatus(false, "❌ bulk create: <span class='mono'>" + String(e) + "</span>");
      }
    }
  </script>
</head>

<body>
  <h2>Noda VR Smoke Test</h2>

  <div id="status" class="box bad">
    ⏳ Жду инициализацию Noda WebAPI…
  </div>

  <div class="box">
    <button onclick="clearMap()">1) Clear map</button>
    <button onclick="createOneHugeNode()">2) Create ONE huge node</button>
    <button onclick="createManyNodes()">3) Create MANY nodes</button>
    <div style="margin-top:10px; font-size: 13px;">
      Если после <b>Create ONE huge node</b> ничего не появилось — почти наверняка страница открыта не внутри Noda Browser, либо окно “смотрит” не туда.
    </div>
  </div>

  <div class="box">
    <div style="margin-bottom:6px;">Логи (видно прямо на странице):</div>
    <textarea id="log" readonly></textarea>
  </div>
</body>
</html>
