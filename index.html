<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noda Minimal Smoke Test (custom noda.js)</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; }
    .box { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 10px 0; }
    .ok { background:#e9fbe9; }
    .bad { background:#ffe9e9; }
    .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #999; background:#f7f7f7; cursor:pointer; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>

  <!-- ВАЖНО: твоя ссылка -->
  <script
    src="https://raw.githubusercontent.com/AlexanderKozhevin/noda-test/main/noda.js"
    onload="window.__nodaJsLoaded=true; window.__log('✅ custom noda.js loaded');"
    onerror="window.__nodaJsError=true; window.__log('❌ custom noda.js failed to load');"
  ></script>

  <script>
    function $(id){ return document.getElementById(id); }

    function setBox(id, ok, html) {
      const el = $(id);
      el.className = "box " + (ok ? "ok" : "bad");
      el.innerHTML = html;
    }

    function __log(msg) {
      const el = $("log");
      el.textContent = (msg + "\n" + el.textContent).slice(0, 6000);
    }
    window.__log = __log;

    function snapshot() {
      const jsLoaded = !!window.__nodaJsLoaded;
      const jsError  = !!window.__nodaJsError;
      const hasNoda  = !!window.noda;

      setBox("script", !jsError, `
        <b>Script</b><br/>
        loaded: <span class="mono">${jsLoaded}</span><br/>
        error: <span class="mono">${jsError}</span><br/>
        src: <span class="mono">raw.githubusercontent.com/.../noda.js</span>
      `);

      setBox("obj", hasNoda, `
        <b>window.noda</b><br/>
        exists: <span class="mono">${hasNoda}</span>
      `);

      let installed = null;
      let installedOk = false;

      if (hasNoda) {
        try {
          installed = window.noda.isInstalled();
          installedOk = (installed === true);
        } catch (e) {
          installed = "ERR: " + String(e);
        }
      }

      setBox("ctx", installedOk, `
        <b>VR context</b><br/>
        isInstalled(): <span class="mono">${String(installed)}</span><br/>
        <div style="margin-top:6px">
          Если <span class="mono">false</span> — страница открыта НЕ в Noda Browser (или URL запрещён в настройках Noda).
        </div>
      `);
    }

    document.addEventListener("DOMContentLoaded", () => {
      __log("DOMContentLoaded");

      // Показываем состояние каждые 300мс первые ~15 секунд
      let ticks = 0;
      const t = setInterval(async () => {
        ticks++;
        snapshot();

        // Если noda есть и контекст true — попробуем getUser (не обязательно, но полезно)
        if (window.noda) {
          try {
            const installed = window.noda.isInstalled();
            if (installed === true) {
              try {
                const user = await window.noda.getUser();
                setBox("user", true, `<b>User</b><br/>userId: <span class="mono">${user.userId}</span>`);
                clearInterval(t);
              } catch (e) {
                setBox("user", false, `<b>User</b><br/>getUser error: <span class="mono">${String(e)}</span>`);
              }
            }
          } catch (_) {}
        }

        if (ticks > 50) clearInterval(t);
      }, 300);

      // Если вдруг библиотека всё-таки дергает onInitialized — залогируем
      try {
        if (window.noda) window.noda.onInitialized = () => __log("✅ onInitialized fired");
      } catch (_) {}
    });

    async function createOneNode() {
      try {
        if (!window.noda) throw new Error("window.noda missing");
        if (!window.noda.isInstalled()) throw new Error("isInstalled() is false — not in Noda Browser (or URL not allowed)");

        const node = await window.noda.createNode({
          uuid: "smoke:one",
          title: "SMOKE NODE — MUST BE VISIBLE",
          color: "F44336",
          opacity: 1,
          shape: "Box",
          size: 22,
          notes: "Если видишь эту ноду перед окном — всё работает.",
          location: { x: 0, y: 0, z: -0.8, relativeTo: "Window" }
        });

        __log("Created node uuid=" + node.uuid);
      } catch (e) {
        __log("createNode ERROR: " + String(e));
      }
    }

    async function createManyNodes() {
      try {
        if (!window.noda) throw new Error("window.noda missing");
        if (!window.noda.isInstalled()) throw new Error("isInstalled() is false — not in Noda Browser (or URL not allowed)");

        const N = 150;
        for (let i = 0; i < N; i++) {
          const row = i % 15;
          const col = Math.floor(i / 15);
          const x = (row - 7) * 0.12;
          const y = col * 0.10;
          const z = -1.2 - (i % 7) * 0.06;

          await window.noda.createNode({
            uuid: "smoke:n" + i,
            title: "#" + i,
            color: (i % 3 === 0) ? "2196F3" : (i % 3 === 1) ? "4CAF50" : "FFB020",
            opacity: 1,
            shape: (i % 4 === 0) ? "Star" : (i % 4 === 1) ? "Diamond" : (i % 4 === 2) ? "Hourglass" : "Box",
            size: 7,
            notes: "bulk " + i,
            location: { x, y, z, relativeTo: "Window" }
          });
        }

        await window.noda.createLink({
          uuid: "smoke:link",
          fromUuid: "smoke:n0",
          toUuid: "smoke:n149",
          title: "range",
          color: "171717",
          shape: "Dash",
          size: 2,
          curve: "None",
          trail: "Ring",
          selected: false
        });

        __log("Created " + N + " nodes + 1 link");
      } catch (e) {
        __log("createMany ERROR: " + String(e));
      }
    }

    async function clearMap() {
      try {
        if (!window.noda) throw new Error("window.noda missing");
        if (!window.noda.isInstalled()) throw new Error("isInstalled() is false — not in Noda Browser (or URL not allowed)");
        await window.noda.clearMap();
        __log("clearMap OK");
      } catch (e) {
        __log("clearMap ERROR: " + String(e));
      }
    }
  </script>
</head>

<body>
  <h2>Noda Minimal Smoke Test</h2>

  <div id="script" class="box bad">…</div>
  <div id="obj" class="box bad">…</div>
  <div id="ctx" class="box bad">…</div>
  <div id="user" class="box bad"><b>User</b><br/>waiting…</div>

  <div class="box">
    <button onclick="clearMap()">Clear map</button>
    <button onclick="createOneNode()">Create ONE node (Window)</button>
    <button onclick="createManyNodes()">Create MANY nodes</button>
    <div style="margin-top:8px; font-size:12px;">
      Если даже “ONE node” не виден, но ошибок нет — почти всегда <span class="mono">isInstalled() = false</span>.
    </div>
  </div>

  <div class="box">
    <b>Log</b>
    <pre id="log"></pre>
  </div>
</body>
</html>
